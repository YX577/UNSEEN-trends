---
title: "Predictive skill"
author: "Timo Kelder"
date: "October 19, 2019"
output: github_document 
---

```{r eval=FALSE, include=FALSE}
Rscript -e "rmarkdown::render('Predictive_skill.Rmd')"
```

In this notebook, we will first show the forecasts of the Norwegian West Coast compared to observed values and then we will assess the skill of the forecasts. 

## Import data and packages

```{r}
# dir='//home/timok/timok/SALIENSEAS/SEAS5/ensex'
# plotdir=paste0(dir,'/statistics/multiday/plots')
# dir='/home/timok/ensex'
# plotdir='/home/timok/Documents/ensex/R/graphs'
dir='C:/Users/gytk3/OneDrive - Loughborough University/GitHub/EnsEx/Data'

source('Load_data.R')
library(moments)
```

##SEAS5 compared to SeNorge

```{r}
require(plyr)
names(dimnames(Extremes_WC)) <- c('Member', 'Leadtime', 'Year')
names(dimnames(Extremes_SV)) <- c('Member', 'Leadtime', 'Year')
df_WC=adply(Extremes_WC, 1:3)
df_SV=adply(Extremes_SV, 1:3)
extremes_wc_biascor= df_WC$V1 * mean(obs)/mean(df_WC$V1) ## we create a mean bias corrected series  

```

We would want to proof that they are similar. Therefore, we want to show the confidence interval of the ecdf of all lead times pooled together. The sample size should be the same as the ecdfs for each lead time, so we bootstrap the pooled leadtimes into series with equal length of the single leadtimes, with n=10000.  
I have tried to add these confidence intervals but I dont know whether this is the right way and I dont know how to add these confidence intervals to the ggplot.  
```{r}

#bootstraps the series to 35 years length with n= 10.000 
bootstrapped_series_WC=sample(df_WC$V1,size = 35*10000,replace = T) #For WC
bootstrapped_series_WC_biascor=sample(extremes_wc_biascor,size = 35*10000,replace = T) #For WC
bootstrapped_array_WC=array(bootstrapped_series_WC,dim = c(35,10000)) #Creates an array with 10.000 series of 35 values
bootstrapped_array_WC_biascor=array(bootstrapped_series_WC_biascor,dim = c(35,10000)) #Same for the mean bias corrected series
# plot_hist <- function(bootstrapped_array_WC,fun,main) {
#   bootstrapped_fun=apply(bootstrapped_array_WC,MARGIN = 2,FUN = fun)
#   hist(bootstrapped_fun,col=alpha('orange',0.5),main=main)
#   # quantile(bootstrapped_skewness,probs = c(0.025,0.975))
#   lines(x=rep(quantile(bootstrapped_fun,probs = c(0.025)),2),y=c(0,5000))
#   lines(x=rep(quantile(bootstrapped_fun,probs = c(0.975)),2),y=c(0,5000))
#   lines(x=rep(fun(obs),2),y=c(0,5000),lwd=2,col='blue')
# }
# 
# hist(bootstrapped_fun,col=alpha('orange',0.5))

plot_hist <- function(bootstrapped_array_WC,fun,main,col) {
  bootstrapped_fun=apply(bootstrapped_array_WC,MARGIN = 2,FUN = fun)
  ggplot()+
    geom_histogram(aes(x=bootstrapped_fun),color='black',fill=col,alpha=0.5)+
    geom_vline(aes(xintercept=quantile(bootstrapped_fun,probs = c(0.025,0.975))),
              color="black", linetype="dashed", size=1)+
    geom_vline(aes(xintercept=fun(obs)),
              color="blue", size=2)+
    labs(title=main,x ="SON-3DP")+
    theme_classic()
}

  geom_line(aes(x=rep(quantile(bootstrapped_fun,probs = c(0.025)),2),y=c(0,5000)))

p1=plot_hist(bootstrapped_array_WC,mean,'Mean','black')
p2=plot_hist(bootstrapped_array_WC,sd,'Standard Deviation','black')
p3=plot_hist(bootstrapped_array_WC,skewness,'Skewness','black')
p4=plot_hist(bootstrapped_array_WC,kurtosis,'Kurtosis','black')

p1_cor=plot_hist(bootstrapped_array_WC_biascor,mean,'Mean','orange')
p2_cor=plot_hist(bootstrapped_array_WC_biascor,sd,'Standard Deviation','orange')
p3_cor=plot_hist(bootstrapped_array_WC_biascor,skewness,'Skewness','orange')
p4_cor=plot_hist(bootstrapped_array_WC_biascor,kurtosis,'Kurtosis','orange')

ggarrange(p1,p2,p3,p4,
          labels = c("A", "B","C","D"),
          ncol = 2, nrow = 2)%>% 
  ggsave(filename = "../graphs/Fidelity_UNSEEN.png",width =8,height = 8 )

ggarrange(p1_cor,p2_cor,p3_cor,p4_cor,
          labels = c("A", "B","C","D"),
          ncol = 2, nrow = 2)%>% 
  ggsave(filename = "../graphs/Fidelity_UNSEEN_biascor.png",width =8,height = 8 )

```


